# Скрипт для установки AmneziaWG и скрипта awgcreate
- Скрипт создавался и тестировался под ОС Ubuntu22/24 и Debian12/13. На других ОС может работать некорректно.
- Чтобы скачать AmneziaWG и скрипт, используйте эту команду:
```sh
wget -qO- https://raw.githubusercontent.com/ShiffGray/awg-create/refs/heads/main/installawg.sh | bash
```

---

## Краткий обзор

awgcreate помогает:
- Создать серверный конфиг AmneziaWG и PostUp/PostDown скрипты;
- Создать шаблон клиентского конфига;
- Добавлять/обновлять/удалять клиентов (peer) в серверном конфиге;
- Генерировать готовые клиентские конфиги (All и DsYt);
- Генерировать QR-коды для конфигов;
- Упаковывать клиентские файлы в ZIP;
- Опционально генерировать серверные WARP-конфиги (Cloudflare) и управлять мульти‑WARP маршрутизацией для выхода в интернет не напрямую с внешнего адреса сервера, а через WARP.

---

## Требования

- Python 3.8+.
- На Linux (для генерации ключей и сетевых операций):
  - `openssl` (для генерации preshared key).
  - `curl` (для получения внешнего IP).
  - `ip`, `iptables`, `ip6tables`, `tc`, `iproute2` и пр. — используются в сгенерированных PostUp/PostDown-скриптах.
- Python-библиотеки:
  - requests
  - qrcode
  Установка зависимостей:
  ```bash
  apt install -y curl wget iptables python3 python3-pip python3-qrcode python3-requests
  ```

Примечания:
- Полноценная работа по управлению сервером ожидается на Linux `Debian`, `Ubuntu`.
- Для выполнения многих действий (создание PostUp/PostDown, правка системных конфигов) нужен root.
- Настоятельно рекомендуется создавать серверные конфиги в `/etc/amnezia/amneziawg`.
- Клиентские конфиги ищите в папке `conf` рядом со скриптом.

---

## CLI: опции и команды
Скопировать и скачать скрипт на сервер:
```bash
wget -O awgcreate.py https://raw.githubusercontent.com/ShiffGray/awg-create/refs/heads/main/awgcreate.py
```
Примеры команд скрипта:
```bash
## python3 awgcreate.py [опции]

# Создать серверный интерфейс с именем awg0, подсетью 10.1.0.0/24, портом 44567, лимитом скорости для пользователей 99Мб/сек,
# MTU 1388 и 3 WARP конфига между которыми будет балансироваться трафик пользователей
python3 awgcreate.py --make /etc/amnezia/amneziawg/awg0.conf -i 10.1.0.0/24 -p 44567 -l 99 --mtu 1388 --warp 3

# Создать пользователя с именем test на awg0
python3 awgcreate.py -s awg0 -a test
# Удалить пользователя test на awg0
python3 awgcreate.py -s awg0 -d test
# Пересгенерировать ключи пользователя test на awg0 (ну тоесть сбросить данные подключения пользователя/пересоздать его)
python3 awgcreate.py -s awg0 -u test

# Сгенерировать zip архив с конфигами и qr-код для пользователя test, так же можно сгенерировать только qr-коды через флаг -q
# и только конфиги через -c , а через флаг -o указываеться конкретный пользователь или список пользователей
# -o test,test2,test3 , без него генерация будет для всех пользователей
python3 awgcreate.py -s awg0 -z -o test
```
После создания/удаления/пересоздания пользователя для применения настроек необходимо перезагрузить интерфейс!
Команды для управления самим интерфейсом:
```bash
# Запустить интерфейс
awg-quick up awg0
# Остановить
awg-quick down awg0

# Добавить интерфейс в автозагрузки
systemctl enable awg-quick@awg0
# Удалить
systemctl disable awg-quick@awg0
# Перезапустить
systemctl restart awg-quick@awg0

# Вывести список запущенных интерфейсов и пользователей
awg
```

Краткий список опций скрипта (см. полный набор в скрипте):
- -s, --serv-cfg STRING  
  Путь или имя серверного конфига (например `awg0`, `awg0.conf`, `/etc/amnezia/amneziawg/awg0.conf`). Если не указан — читается `.main.config`.
- -a, --add STRING  
  Добавить клиента с указанным именем (секция [Peer] добавляется в конец серверного конфига). Пример: `-a alice`.
- -u, --update STRING  
  Сбросить ключи указанного клиента (генерация новой пары ключей и preshared key).
- -d, --delete STRING  
  Удалить клиента.
- -c, --conf  
  Сгенерировать клиентские конфиги (в `conf/`).
- -q, --qrcode  
  Сгенерировать QR-код для клиента из `*All.conf` в `conf/`.
- -z, --zip  
  Упаковать конфиги и QR-коды клиентов в ZIP.
- -o, --only STRING  
  Генерировать конфиг только для указанных клиентов (список, через запятую). Пример: `--only alice,bob`
- -t, --tmpcfg STRING  
  Имя шаблона клиентского конфига (по умолчанию `_defclient.config`).
- -i, --ipaddr STRING  
  IP-адрес сервера / вручную задаваемый IP при создании шаблонов / добавлении клиента. Поддерживается CIDR (например `10.1.0.0/24`).
- -p, --port INT  
  Порт сервера (при создании серверного конфига).
- -l, --limit INT  
  Лимит скорости трафика (в мегабит/секунду), использующийся в шаблонах PostUp (по умолчанию 99).
- --make STRING  
  Создать новый серверный конфиг (и Post Up/Down скрипты). Пример: `--make /etc/amnezia/amneziawg/awg0.conf`
- --tun STRING  
  Имя туннеля при создании конфига (`--make`).
- --create  
  Создать шаблон клиентского конфига (`_defclient.config` по умолчанию).
- --mtu INT  
  MTU, используется при генерации (по умолчанию 1388). Скрипт проверяет диапазон 1280—1420.
- --warp INT  
  Сгенерировать N WARP-конфигов (Cloudflare) при создании сервера (`--make`).

---

## Файловая организация и важные нюансы
- `/etc/amnezia/amneziawg` — дериктория по умолчанию для всех интерфейсов и Post Up/Down скриптов, НАСТОЯТЕЛЬНО рекомендую использовать именно её для того чтобы не морочить себе мозг!
- `.main.config` — хранит путь до серверного конфига. Если вы используете разные серверные конфиги, либо указывайте `-s` или `--serv-cfg`, либо корректируйте `.main.config`.
- `conf/` — все сгенерированные клиентские файлы: `*All.conf`, `*DsYt.conf`, `*All.png`, `*.zip`.
- Если шаблон `_defclient.config` отсутствует, при генерации клиентских конфигов скрипт автоматически создаёт его (с использованием внешнего IP если `--ipaddr` не задан).
- Скрипт записывает в серверный конфиг `#_PrivateKey` и другие #_-строки, которые используются для хранения приватных значений (они закомментированы в файле, но парсятся скриптом).

---

## Безопасность и рекомендации (но вам не обязательно им следовать)

- На всякий случай можете делать резервные копии серверных конфигов.
- Скрипт записывает приватные ключи (в секциях `#_PrivateKey`), убедитесь, что никто лишний не имеет доступа к серверному конфигу и все права на файлы защищены:
  ```bash
  sudo chown root:root /etc/amnezia/amneziawg/awg0.conf
  sudo chmod 600 /etc/amnezia/amneziawg/awg0.conf
  ```
- Сгенерированные PNG и ZIP в `conf/` тоже содержат чувствительные данные — храните эту папку в защищённом месте и удаляйте после доставки клиентам.

---

## Troubleshooting (частые ошибки)

- "Ошибка: основной WG конфиг не найден!"  
  Убедитесь, что вы:
  - Либо указали `-s awg0`;
  - Либо в `.main.config` записан корректный путь к конфигу (первая строка).
- Проблемы с генерацией ключей (ошибка при вызове `awg genkey`):  
  Убедитесь, что `awg` доступен в PATH и запускаются от root.
- QR не генерируется / конфиг слишком большой:  
  Скрипт предупреждает, если файл > 2KiB. Попробуйте сократить конфиг (меньше AllowedIPs) или использовать альтернативные способы доставки.
- Ошибки Cloudflare WARP (429 Too Many Requests):  
  Скрипт пропускает генерацию WARP (может быть с IP вашего сервера по какой либо причине заблокирован доступ к API Cloudflare).

---

## FAQ


Q: Где лежат сгенерированные WARP-конфиги?  
A: Они сохраняются рядом с основным серверным конфигом (в той же директории), имена вида `<tun_name>warp<i>.conf`.

Q: Как скрипт выбирает IP для нового клиента?  
A: Он берёт подсеть из `Address` в секции [Interface] серверного конфига (CIDR), и ищет первый свободный IP (после base IP). Возможна ручная передача `--ipaddr`.

Q: Что делает `DsYt` конфиг?  
A: `DsYt` — вариант клиентского конфига с AllowedIPs, содержащим список подсетей/адресов для доступа к заранее указанным сервисам (YouTube, Discord, ChatGPT, Pornhub и т. п.). Списки извлекаются из `https://iplist.opencck.org/` (cidr4/cidr6).

---
