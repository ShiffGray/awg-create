# Скрипт для авто установки AmneziaWG и настройки интерфейса с пользователями при помощи awgcreate
- Скрипт создавался и тестировался под ОС Ubuntu22x64 и Ubuntu24x64. На других ОС может работать некорректно.
- Чтобы скачать и запустить скрипт, используйте эту команду:
```sh
wget -qO- https://raw.githubusercontent.com/ShiffGray/awg-create/refs/heads/main/installawg.sh | bash
```
- После выполнения ищите клиентские конфиги в папке `conf` рядом со скриптом.

# awgcreate — утилита для управления конфигами AmneziaWG

Это Python-скрипт для быстрой генерации и управления серверными и клиентскими конфигурациями AmneziaWG (форк WireGuard), автоматического создания Post Up/Down скриптов, генерации WARP-конфигов (Cloudflare WARP), QR-кодов и ZIP-архивов с конфигами клиентов.

Файл скрипта: `awgcreate.py`

Ниже — подробная документация по установке, требованиям, использованию и примерам.

---

## Краткий обзор

awgcreate помогает:
- Создать серверный конфиг AmneziaWG и PostUp/PostDown скрипты;
- Создать шаблон клиентского конфига;
- Добавлять/обновлять/удалять клиентов (peer) в серверном конфиге;
- Генерировать готовые клиентские конфиги (All и DsYt);
- Генерировать QR-коды для конфигов;
- Упаковывать клиентские файлы в ZIP;
- Опционально генерировать серверные WARP-конфиги (Cloudflare) и управлять мульти‑WARP маршрутизацией для выхода в интернет не напрямую с внешнего адреса сервера, а через WARP.

---

## Требования

- Python 3.8+ (использование `subprocess.run` с `encoding='utf8'`).
- На Linux (для генерации реальных ключей и сетевых операций):
  - `openssl` (для генерации preshared key).
  - `curl` (для получения внешнего IP).
  - `ip`, `iptables`, `ip6tables`, `tc`, `iproute2` и пр. — используются в сгенерированных PostUp/PostDown-скриптах.
- Python-библиотеки:
  - requests
  - qrcode
  - pillow (PIL) — необходим для сохранения PNG
  Установка зависимостей:
  ```bash
  pip3 install requests qrcode pillow
  ```

Примечания:
- Полноценная работа по управлению сервером ожидается на Linux `Debian`, `Ubuntu`.
- Для выполнения многих действий (создание PostUp/PostDown, правка системных конфигов) нужен root.
- Настоятельно рекомендуется создавать серверные конфиги в `/etc/amnezia/amneziawg`.

---

## CLI: опции и команды
Скопировать и скачать скрипт на сервер:
```bash
wget -O awgcreate.py https://raw.githubusercontent.com/ShiffGray/awg-create/refs/heads/main/awgcreate.py
```
Запуск:
```bash
python3 awgcreate.py [опции]
```

Краткий список опций (см. полный набор в скрипте):
- -s, --serv-cfg STRING  
  Путь или имя серверного конфига (например `awg0`, `awg0.conf`, `/etc/amnezia/amneziawg/awg0.conf`). Если не указан — читается `.main.config`.
- -a, --add STRING  
  Добавить клиента с указанным именем (секция [Peer] добавляется в конец серверного конфига). Пример: `-a alice`.
- -u, --update STRING  
  Сбросить ключи указанного клиента (генерация новой пары ключей и preshared key).
- -d, --delete STRING  
  Удалить клиента.
- -c, --conf  
  Сгенерировать клиентские конфиги (в `conf/`).
- -q, --qrcode  
  Сгенерировать QR-код для клиента из `*All.conf` в `conf/`.
- -z, --zip  
  Упаковать конфиги и QR-коды клиентов в ZIP.
- -o, --only STRING  
  Генерировать конфиг только для указанных клиентов (список, через запятую). Пример: `--only alice,bob`
- -t, --tmpcfg STRING  
  Имя шаблона клиентского конфига (по умолчанию `_defclient.config`).
- -i, --ipaddr STRING  
  IP-адрес сервера / вручную задаваемый IP при создании шаблонов / добавлении клиента. Поддерживается CIDR (например `10.0.0.1/24`).
- -p, --port INT  
  Порт сервера (при создании серверного конфига).
- -l, --limit INT  
  Лимит скорости трафика (в мегабит/секунду), использующийся в шаблонах PostUp (по умолчанию 99).
- --make STRING  
  Создать новый серверный конфиг (и Post Up/Down скрипты). Пример: `--make /etc/amnezia/amneziawg/awg0.conf`
- --tun STRING  
  Имя туннеля при создании конфига (`--make`).
- --create  
  Создать шаблон клиентского конфига (`_defclient.config` по умолчанию).
- --mtu INT  
  MTU, используется при генерации (по умолчанию 1388). Скрипт проверяет диапазон 1280—1420.
- --warp INT  
  Сгенерировать N WARP-конфигов (Cloudflare) при создании сервера (`--make`).

---

## Файловая организация и важные нюансы

- `.main.config` — хранит путь до серверного конфига. Если вы используете разные серверные конфиги, либо указывайте `-s` или `--serv-cfg`, либо корректируйте `.main.config`.
- `conf/` — все сгенерированные клиентские файлы: `*All.conf`, `*DsYt.conf`, `*All.png`, `*.zip`.
- Если шаблон `_defclient.config` отсутствует, при генерации клиентских конфигов скрипт автоматически создаёт его (с использованием внешнего IP если `--ipaddr` не задан).
- Скрипт записывает в серверный конфиг `#_PrivateKey` и другие #_-строки, которые используются для хранения приватных значений (они закомментированы в файле, но парсятся скриптом).

---

## Безопасность и рекомендации (но вам не обязательно следовать всем указаниям)

- На всякий случай делайте резервную копию серверного конфига.
- Скрипт записывает приватные ключи (в секциях `#_PrivateKey`), убедитесь, что никто лишний не имеет доступа к серверному конфигу и все права на файлы защищены:
  ```bash
  sudo chown root:root /etc/amnezia/amneziawg/awg0.conf
  sudo chmod 600 /etc/amnezia/amneziawg/awg0.conf
  ```
- Сгенерированные PNG и ZIP в `conf/` тоже содержат чувствительные данные — храните эту папку в защищённом месте и удаляйте после доставки клиентам.

---

## Troubleshooting (частые ошибки)

- "Ошибка: основной WG конфиг не найден!"  
  Убедитесь, что вы:
  - Либо указали `-s /path/to/awg0.conf`;
  - Либо в `.main.config` записан корректный путь к конфигу (первая строка).
- Проблемы с генерацией ключей (ошибка при вызове `wg genkey`):  
  Убедитесь, что `wg` или `awg` доступны в PATH и запускаются от root.
- QR не генерируется / конфиг слишком большой:  
  Скрипт предупреждает, если файл > 2KiB. Попробуйте сократить конфиг (меньше AllowedIPs) или использовать альтернативные способы доставки.
- Ошибки Cloudflare WARP (429 Too Many Requests):  
  Скрипт делает до 3 попыток и ждёт 20 секунд при ответе 429. Если лимит постоянен — уменьшите `--warp` или запустите позже (может быть с IP вашего сервера по какой либо причине заблокирован доступ к API Cloudflare).

---


## FAQ


Q: Где лежат сгенерированные WARP-конфиги?  
A: Они сохраняются рядом с основным серверным конфигом (в той же директории), имена вида `<tun_name>warp<i>.conf`.

Q: Как скрипт выбирает IP для нового клиента?  
A: Он берёт подсеть из `Address` в секции [Interface] серверного конфига (CIDR), и ищет первый свободный IP (после base IP). Возможна ручная передача `--ipaddr`.

Q: Что делает `DsYt` конфиг?  
A: `DsYt` — вариант клиентского конфига с AllowedIPs, содержащим список подсетей/адресов для доступа к заранее указанным сервисам (YouTube, Discord, ChatGPT, Pornhub и т. п.). Списки извлекаются из `https://iplist.opencck.org/` (cidr4/cidr6).

---


## Примеры команд


1) Создать серверный конфиг:
```bash
sudo python3 awgcreate.py --make /etc/amnezia/amneziawg/awg0.conf --ipaddr 10.1.0.0/23 --port 44567 --mtu 1388 --warp 3 --limit 99
```
- Скрипт:
  - Создаст интерфейс `/etc/amnezia/amneziawg/awg0.conf` с локальной подсетью для клиентов 10.1.0.0/23, портом 44567, MTU 1388 (у WARP будит такой же) и лимитом скорости для пользователей 99 мегабит/секунду;
  - Создаст рядом с конфигом Post Up/Down скрипты `awg0up.sh` и `awg0down.sh`;
  - Создаст рядом с конфигом 3 WARP `awg0warp0.conf`, `awg0warp1.conf`, `awg0warp2.conf`;
  - Запишет путь `/etc/amnezia/amneziawg/awg0.conf` в `.main.config` (файл рядом со скриптом), чтобы последующие вызовы могли использовать этот путь автоматически.
- WARP опционален но если будите генерировать WARP-конфиги (Cloudflare), то можете столкнутся с лимитами API (просто не генерируйте 20 WARP! это бессмысленно так как вам хватит 2-3 и то не факт что по ним будут разные внешние IP).


2) Создать шаблон клиентского конфига:
```bash
python3 awgcreate.py --create
```
- Создаст `_defclient.config` в каталоге скрипта (можно вручную передать адрес сервера через --ipaddr или -i).


3) Взаимодействие с пользователем в серверном конфиге (peer):
- Добавить пользователя:
```bash
sudo python3 awgcreate.py -a alice
```
- Сгенерирует ключи пользователя, preshared key и добавит секцию [Peer] в конец серверного конфига.
- Если хотите назначить конкретный IP:
```bash
sudo python3 awgcreate.py -a alice -i 10.1.0.5/32
```
- Сброс ключей пользователя (сбросить/пересоздать пользователя):
```bash
sudo python3 awgcreate.py -u alice
```
- Удалить пользователя:
```bash
sudo python3 awgcreate.py -d alice
```


4) Сгенерировать клиентские конфиги, архивы и QR-коды в `conf/`:
- Конфиги и QR:
```bash
python3 awgcreate.py -c -q
```
- Только архивы(аналогично для конфигов и QR-кодами):
```bash
python3 awgcreate.py -z
```
- Или QR-код для конкретного клиента(аналогично для конфигов и архивов):
```bash
python3 awgcreate.py -q -o alice
```
- Указать серверный конфиг для генерации:
```bash
python3 awgcreate.py -s awg0 -c
```
- Если `-s` или `--serv-cfg` не указан, берётся путь из `.main.config`.
- Будут созданы файлы `conf/<client>All.conf`, `conf/<client>DsYt.conf`, `<client>All.png` и `conf/<client>.zip` (или только те что переданы через флаги, остальные удалятся) для каждого клиента (или только для тех, что переданы в `-o` или `--only`, для остальных удалятся).
- При генерации только архивов все файлы `All.conf`, `DsYt.conf`, `All.png` будут сгенерированный и включены в архив `conf/<client>.zip`
- Внимание: QR код ограничен по объёму. Скрипт пытается подобрать версию, но если конфиг > ~2KiB, рискуете не поместиться в QR (будет предупреждение).

---
